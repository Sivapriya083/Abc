<?xml version="1.0"?>
<robot name="ur5e">

  <!-- BASE LINK -->

  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="4.0"/>
      <inertia
        ixx="0.004" ixy="0" ixz="0"
        iyy="0.004" iyz="0"
        izz="0.006"/>
    </inertial>
  </link>


  <!-- LINK 1 -->

  <link name="shoulder_link">

    <inertial>
      <origin xyz="0 0 0.05"/>
      <mass value="3.7"/>
      <inertia
        ixx="0.010"
        iyy="0.010"
        izz="0.006"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- LINK 2 -->

  <link name="upper_arm_link">

    <inertial>
      <origin xyz="0 0 0.2125"/>
      <mass value="8.393"/>
      <inertia
        ixx="0.226"
        iyy="0.226"
        izz="0.015"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- LINK 3 -->

  <link name="forearm_link">

    <inertial>
      <origin xyz="0 0 0.196"/>
      <mass value="2.33"/>
      <inertia
        ixx="0.049"
        iyy="0.049"
        izz="0.004"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- LINK 4 -->

  <link name="wrist_1_link">

    <inertial>
      <origin xyz="0 0 0"/>
      <mass value="1.219"/>
      <inertia
        ixx="0.002"
        iyy="0.002"
        izz="0.001"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- LINK 5 -->

  <link name="wrist_2_link">

    <inertial>
      <origin xyz="0 0 0"/>
      <mass value="1.219"/>
      <inertia
        ixx="0.002"
        iyy="0.002"
        izz="0.001"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- LINK 6 -->

  <link name="wrist_3_link">

    <inertial>
      <origin xyz="0 0 0"/>
      <mass value="0.1879"/>
      <inertia
        ixx="0.0003"
        iyy="0.0003"
        izz="0.0002"
        ixy="0" ixz="0" iyz="0"/>
    </inertial>

  </link>


  <!-- JOINTS -->

  <joint name="shoulder_pan_joint" type="revolute">

    <parent link="base_link"/>
    <child link="shoulder_link"/>

    <origin xyz="0 0 0.1625" rpy="0 0 0"/>

    <axis xyz="0 0 1"/>

    <limit
      lower="-6.283"
      upper="6.283"
      effort="150"
      velocity="3.0"/>

  </joint>


  <joint name="shoulder_lift_joint" type="revolute">

    <parent link="shoulder_link"/>
    <child link="upper_arm_link"/>

    <origin xyz="0 0 0" rpy="0 1.5708 0"/>

    <axis xyz="0 1 0"/>

    <limit
      lower="-6.283"
      upper="6.283"
      effort="150"
      velocity="3.0"/>

  </joint>


  <joint name="elbow_joint" type="revolute">

    <parent link="upper_arm_link"/>
    <child link="forearm_link"/>

    <origin xyz="-0.425 0 0" rpy="0 0 0"/>

    <axis xyz="0 1 0"/>

    <limit
      effort="150"
      velocity="3"/>

  </joint>


  <joint name="wrist_1_joint" type="revolute">

    <parent link="forearm_link"/>
    <child link="wrist_1_link"/>

    <origin xyz="-0.3922 0 0.1333"/>

    <axis xyz="0 1 0"/>

    <limit effort="150" velocity="3"/>

  </joint>


  <joint name="wrist_2_joint" type="revolute">

    <parent link="wrist_1_link"/>
    <child link="wrist_2_link"/>

    <origin xyz="0 0 0.0997"/>

    <axis xyz="0 0 1"/>

    <limit effort="150" velocity="3"/>

  </joint>


  <joint name="wrist_3_joint" type="revolute">

    <parent link="wrist_2_link"/>
    <child link="wrist_3_link"/>

    <origin xyz="0 0 0.0996"/>

    <axis xyz="0 1 0"/>

    <limit effort="150" velocity="3"/>

  </joint>


  <!-- ROS2 CONTROL -->

  <ros2_control name="UR5eSystem" type="system">

    <hardware>

      <plugin>
        gz_ros2_control/GazeboSimSystem
      </plugin>

    </hardware>


    <joint name="shoulder_pan_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


    <joint name="shoulder_lift_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


    <joint name="elbow_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


    <joint name="wrist_1_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


    <joint name="wrist_2_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


    <joint name="wrist_3_joint">

      <command_interface name="effort"/>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>

    </joint>


  </ros2_control>


  <!-- TRANSMISSIONS -->
  <!-- REQUIRED FOR EFFORT CONTROL -->

  <transmission name="trans_shoulder_pan">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="shoulder_pan_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

    <actuator name="motor_shoulder_pan">

      <mechanicalReduction>
        1
      </mechanicalReduction>

    </actuator>

  </transmission>


  <transmission name="trans_shoulder_lift">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="shoulder_lift_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

    <actuator name="motor_shoulder_lift">

      <mechanicalReduction>
        1
      </mechanicalReduction>

    </actuator>

  </transmission>


  <transmission name="trans_elbow">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="elbow_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

    <actuator name="motor_elbow">

      <mechanicalReduction>
        1
      </mechanicalReduction>

    </actuator>

  </transmission>


  <transmission name="trans_wrist1">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="wrist_1_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

  </transmission>


  <transmission name="trans_wrist2">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="wrist_2_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

  </transmission>


  <transmission name="trans_wrist3">

    <type>
      transmission_interface/SimpleTransmission
    </type>

    <joint name="wrist_3_joint">

      <hardwareInterface>
        hardware_interface/EffortJointInterface
      </hardwareInterface>

    </joint>

  </transmission>


  <!-- GAZEBO ROS2 CONTROL PLUGIN -->

  <gazebo>

    <plugin
        filename="libgz_ros2_control-system.so"
        name="gz_ros2_control::GazeboSimROS2ControlPlugin"/>

  </gazebo>


</robot>


import os
from launch import LaunchDescription
from launch.actions import (
    DeclareLaunchArgument,
    IncludeLaunchDescription,
    OpaqueFunction,
    SetEnvironmentVariable,
)
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.substitutions import FindPackageShare


def launch_setup(context, *args, **kwargs):
    ur_type = LaunchConfiguration("ur_type")
    gz_world = LaunchConfiguration("gz_world")

    ur_gazebo_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            PathJoinSubstitution([
                FindPackageShare("ur_simulation_gz"),
                "launch",
                "ur_sim_control.launch.py",
            ])
        ),
        launch_arguments={
            "ur_type": ur_type,
            "gz_world": gz_world,
            "launch_rviz": "false",
        }.items(),
    )

    return [ur_gazebo_launch]


def generate_launch_description():
    declared_args = [
        DeclareLaunchArgument(
            "ur_type",
            default_value="ur5e",
            description="Type of UR robot: ur3, ur3e, ur5, ur5e, ur10, ur10e, ur16e",
        ),
        DeclareLaunchArgument(
            "gz_world",
            default_value="empty.sdf",
            description="Gazebo world file to load",
        ),
    ]

    # Force NVIDIA GPU for OGRE2 rendering
    env_vars = [
        SetEnvironmentVariable("__NV_PRIME_RENDER_OFFLOAD", "1"),
        SetEnvironmentVariable("__GLX_VENDOR_LIBRARY_NAME", "nvidia"),
        SetEnvironmentVariable(
            "__EGL_VENDOR_LIBRARY_FILENAMES",
            "/usr/share/glvnd/egl_vendor.d/10_nvidia.json"
        ),
        SetEnvironmentVariable("GZ_IP", "127.0.0.1"),
        SetEnvironmentVariable("GZ_RELAY", "127.0.0.1"),
    ]

    return LaunchDescription(env_vars + declared_args + [OpaqueFunction(function=launch_setup)])








